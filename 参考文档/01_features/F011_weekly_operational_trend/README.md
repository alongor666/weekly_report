# 周度经营趋势分析模块

> **状态**: ✅ 完成
> **优先级**: P0
> **完整度**: 100%
> **版本**: v1.0.0
> **最后验证**: 2025-10-26

## 功能概述

专为车险经营分析设计的周度趋势可视化组件，聚焦于核心经营指标（签单保费、赔付率）的趋势监控和风险预警。采用 ECharts 实现高性能、高交互的图表展示，支持风险点识别、下钻分析和经营摘要自动生成。

## 核心能力

### 1. 双Y轴设计
- ✅ **左Y轴**: 签单保费（万元），蓝色面积图展示业务规模趋势
- ✅ **右Y轴**: 赔付率（%），橙色点线图展示风险水平
- ✅ **智能刻度**: 右轴仅显示关键数值（70%阈值、平均值、当前值）

### 2. 风险预警机制
- ✅ **阈值线**: 赔付率70%红色虚线作为风险警戒线
- ✅ **风险区域**: 赔付率≥70%区域背景淡红色标识
- ✅ **风险点高亮**: 赔付率≥70%的周次显示为橙色大圆点，视觉突出
- ✅ **连续预警**: 自动统计连续高风险周数并在摘要中提醒

### 3. 趋势分析
- ✅ **线性回归**: 紫色虚线展示赔付率的长期趋势方向
- ✅ **最小二乘法**: 使用标准统计算法计算趋势线
- ✅ **拐点识别**: 通过趋势线与实际值的偏离度识别经营拐点

### 4. 智能Tooltip
- ✅ **基础信息**: 周次、签单保费、赔付率
- ✅ **风险评估**: 与70%阈值的差值（正/负）
- ✅ **视觉区分**: 风险点以红色高亮显示赔付率数值

### 5. 交互功能
- ✅ **点击下钻**: 点击风险点触发下钻分析（车型/机构剖面）
- ✅ **时间缩放**: DataZoom滑块支持拖拽缩放时间范围
- ✅ **默认视图**: 自动显示最近26周数据（约半年），并在进入“周趋势分析”标签时强制切换为多选模式且默认选中全部可用周次，确保周增量视角下可直接对比所有周次。
- ✅ **响应式**: 图表自动适应容器尺寸变化

### 6. 经营摘要
- ✅ **自动生成**: 基于数据智能生成一句话经营概况
- ✅ **核心指标**: 包含当前周次、年度累计签单保费（最新周的累计值）
- ✅ **风险提示**: 显示连续风险周数或累计风险周数
- ✅ **风险根因**: 若最新周触发赔付率预警，自动串联业务类型 / 三级机构 / 险别组合 Top3 风险贡献文本
- ✅ **结构化洞察**: 输出“经营概览 / 赔付趋势 / 业务类型异常 / 机构集中区域 / 管理建议 / 后续跟踪”六段式文字，全部基于当前筛选条件实时生成
- ✅ **状态评价**: 无风险时显示"经营状况良好"
- ✅ **周增量模式**: 切换至“周增量”数据视图时，额外指出保费周增量的异常周次、赔付预警所在周以及趋势是否恶化和恶化幅度。
- ✅ **中文口径**: 经营摘要中的周次统一采用“第X周”格式，金额统一使用“万元”单位，避免英文缩写。

## 实现文件

### 核心组件
- ✅ [`src/components/features/weekly-operational-trend.tsx`](../../../src/components/features/weekly-operational-trend.tsx) - 主组件实现

### 依赖Hooks
- ✅ [`src/hooks/use-trend.ts`](../../../src/hooks/use-trend.ts) - 趋势数据获取
- ✅ [`src/hooks/use-kpi-trend.ts`](../../../src/hooks/use-kpi-trend.ts) - KPI趋势计算

### 工具函数
- ✅ [`src/utils/format.ts`](../../../src/utils/format.ts) - 数值格式化

## 技术特性

### 图表配置
- **渲染引擎**: Canvas（高性能）
- **降采样**: LTTB算法（大数据优化）
- **图表类型**:
  - Line（签单保费趋势线）
  - Scatter（赔付率点图）
  - Line（阈值线、趋势线）
  - VisualMap（背景风险区）

### 颜色方案
```typescript
// 主色调
签单保费: '#3b82f6' (蓝色)
赔付率正常: '#94a3b8' (灰色)
赔付率风险: '#f97316' (橙色)
阈值线: '#ef4444' (红色)
趋势线: '#8b5cf6' (紫色)
风险区背景: 'rgba(254, 226, 226, 0.3)' (淡红)
```

### 性能优化
- ✅ **React.memo**: 防止不必要的重渲染
- ✅ **useMemo**: 缓存计算密集型数据处理
- ✅ **useRef**: 持久化ECharts实例
- ✅ **LTTB采样**: 大数据集自动降采样
- ✅ **ResizeObserver**: 高效响应式调整

## 交互事件

### 点击事件处理
```typescript
/**
 * 处理风险点点击事件
 * @param point - 被点击的数据点
 *
 * 功能：
 * 1. 控制台输出下钻信息
 * 2. 更新选中状态
 * 3. 触发筛选器更新（TODO）
 * 4. 跳转详情页面（TODO）
 */
const handlePointClick = (point: ChartDataPoint) => {
  console.log('🔍 下钻分析：', point)
  setSelectedPoint(point)
  // TODO: 集成下钻逻辑
  alert(`点击了 ${point.week}\n将进入车型/机构剖面下钻分析`)
}
```

### Tooltip格式化
```typescript
// 动态生成HTML格式的Tooltip
// 包含：
// - 周次标题
// - 签单保费（万元）
// - 赔付率（%，风险值红色显示）
// - 与阈值差值（±pp）
```

## 数据流

```
useTrendData()
  ↓
原始周度数据
  ↓
数据处理（排序、风险标识）
  ↓
chartData: ChartDataPoint[]
  ↓
├─ 签单保费数组 → 蓝色面积图
├─ 赔付率数组 → 分离正常点/风险点
├─ 趋势线计算 → 紫色虚线
├─ 风险原因分析 → 最新风险周Top3组合
└─ 经营摘要生成 → 顶部文字
  ↓
ECharts渲染
```

## 使用方式

### 在页面中集成
```tsx
import { WeeklyOperationalTrend } from '@/components/features/weekly-operational-trend'

export default function TrendPage() {
  return (
    <div className="space-y-6">
      <WeeklyOperationalTrend />
    </div>
  )
}
```

### 数据要求
组件依赖 `useTrendData()` 提供的周度趋势数据，数据格式：
```typescript
interface TrendDataPoint {
  label: string          // 显示标签（如"2025-W42"）
  week: number          // 周次数字
  year: number          // 年份
  signed_premium_10k: number  // 签单保费（万元）
  loss_ratio: number | null   // 赔付率（%）
  // ... 其他字段
}
```

## 扩展点

### 1. 下钻分析集成
```typescript
// TODO: 在 handlePointClick 中添加
updateFilters({
  years: [point.year],
  weeks: [point.weekNumber],
})
router.push('/detail-analysis')
```

### 2. 异常原因服务对接
当前组件已基于本地数据实时输出 Top3 组合。若后续需要与后端异常分析服务对齐，可在风险周定位完成后调用接口，替换或补充现有文案：
```typescript
const payload = {
  year: point.year,
  week: point.weekNumber,
  filters: currentFiltersSnapshot,
}
const { reasons } = await fetchAnomalyReasons(payload)
```

### 3. 更多趋势算法
- 指数平滑（EMA）
- 移动平均（SMA）
- 季节性分解
- ARIMA预测

### 4. 导出功能
- 图表导出为PNG/SVG
- 数据导出为CSV/Excel
- 经营报告PDF生成

## 与原版对比

| 特性 | 原版 TrendChart | 新版 WeeklyOperationalTrend |
|------|----------------|---------------------------|
| 图表库 | Recharts | ECharts |
| 核心指标 | 签单+满期+赔付率 | **签单+赔付率（聚焦）** |
| 风险识别 | 异常检测算法 | **阈值线+背景色（直观）** |
| 趋势线 | 多种算法可选 | **线性回归（简洁）** |
| 下钻功能 | 无 | **点击风险点下钻** |
| 经营摘要 | 洞察标签 | **完整经营话语** |
| 性能 | 良好 | **LTTB优化（更好）** |

## 【重要】数据含义说明

### CSV原始数据特性
**每周的数据是年度累计值**（从1月1日到该周结束的累计），而非单周值。

例如：
- 第1周：1月1日-1月4日的累计数据
- 第2周：1月1日-1月11日的累计数据
- 第42周：1月1日-10月18日的累计数据

### 组件数据处理
`useTrendData()` Hook根据`filters.dataViewType`自动处理数据：

#### 1. 当周值模式 (`dataViewType === 'current'`)
- **签单保费**：显示累计值（年初至今的总保费）
- **赔付率**：基于累计数据计算（累计赔款 / 累计保费）
- **图表表现**：签单保费呈现持续上升曲线（累计值递增）

#### 2. 周增量模式 (`dataViewType === 'increment'`)
- **签单保费**：显示周增量（当周累计 - 上周累计）
- **赔付率**：仍基于累计数据计算（不是单周赔付率！）
- **图表表现**：签单保费呈现波动曲线（每周新增量）

### 赔付率计算逻辑（关键）
```typescript
// ✅ 正确：基于累计数据（组件当前实现）
赔付率(第N周) = 累计赔款(第1-N周) / 累计保费(第1-N周)

// ❌ 错误：单周数据（会导致极大波动）
赔付率(第N周) ≠ 单周赔款(第N周) / 单周保费(第N周)
```

**为什么使用累计赔付率？**
1. **稳定性**：单周赔付率波动极大（某周可能无赔款，某周集中赔付）
2. **准确性**：累计赔付率反映从年初至今的整体风险水平
3. **可比性**：70%阈值是基于整体经营设定，不是单周标准
4. **业务意义**：管理层关心的是"年初至今累计赔付率是否超标"

### Tooltip数据说明
当悬浮在图表上时，Tooltip显示的"签单保费"含义取决于当前模式：
- **当周值模式**："签单保费 12,345 万元" = 年初至今累计
- **周增量模式**："签单保费 215 万元" = 本周新增

而"赔付率 68.5%" **始终是累计赔付率**，无论哪种模式。

## 已知限制

1. **异常原因验证**: 当前基于本地数据实时计算 Top3 组合，尚未与后端异常库或人工结论交叉验证
2. **下钻逻辑**: 点击事件已实现，但下钻页面跳转需进一步集成
3. **多维度交互**: 风险原因仅在摘要中展示文本，尚未开放交互式筛选或图表联动
4. **历史对比**: 不支持多年度叠加对比
5. **数据模式切换**: 组件自动读取全局`dataViewType`，无独立切换开关

## 未来规划

- [ ] 与后端异常分析服务对齐校验，补充更多因子解释
- [ ] 实现完整下钻分析流程
- [ ] 支持机构/车型维度切换
- [ ] 添加多年度对比模式
- [ ] 实现图表/数据导出功能
- [ ] 集成智能预警通知
- [ ] 支持自定义阈值设置

## 相关文档

- [原趋势分析模块 F003](../F003_trend_analysis/README.md)
- [ECharts官方文档](https://echarts.apache.org/zh/index.html)
- [数据架构设计](../../03_technical_design/data_architecture.md)

## 测试清单

- [x] 数据加载正常
- [x] 图表渲染正确
- [x] 风险点高亮显示
- [x] Tooltip信息完整
- [x] 点击事件触发
- [x] 缩放拖拽流畅
- [x] 经营摘要准确
- [x] 响应式布局适配
- [ ] 大数据量性能测试
- [ ] 多浏览器兼容性测试

---

*文档创建时间: 2025-10-26*
*最后更新: 2025-10-26*
*维护者: Claude Code*
