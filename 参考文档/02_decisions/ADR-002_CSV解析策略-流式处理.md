# ADR-002: CSVè§£æç­–ç•¥ - æµå¼å¤„ç†

> **çŠ¶æ€**: âœ… å·²é‡‡çº³
> **å†³ç­–æ—¥æœŸ**: 2025-01-20
> **å†³ç­–äºº**: å¼€å‘å›¢é˜Ÿ

---

## ä¸Šä¸‹æ–‡ (Context)

æ ¹æ® **[CSVå¯¼å…¥è§„èŒƒ](../archive/CSVå¯¼å…¥è§„èŒƒ.md)**ï¼Œç³»ç»Ÿéœ€è¦èƒ½å¤Ÿå¤„ç†å¤§è§„æ¨¡çš„CSVæ–‡ä»¶ã€‚å…·ä½“éœ€æ±‚å¦‚ä¸‹ï¼š

1.  **æ–‡ä»¶è§„æ¨¡**: æœ€å¤§æ”¯æŒ200MBï¼Œçº¦100ä¸‡è¡Œè®°å½•ã€‚
2.  **æ€§èƒ½è¦æ±‚**: 5ä¸‡è¡Œæ•°æ®çš„è§£ææ—¶é—´åº”å°äº10ç§’ã€‚
3.  **å†…å­˜é™åˆ¶**: å¿…é¡»é¿å…å› ä¸€æ¬¡æ€§åŠ è½½æ–‡ä»¶è€Œå¯¼è‡´çš„æµè§ˆå™¨å†…å­˜æº¢å‡ºï¼ˆé€šå¸¸é™åˆ¶åœ¨500MBä»¥å†…ï¼‰ã€‚
4.  **ç”¨æˆ·ä½“éªŒ**: åœ¨æ–‡ä»¶å¤„ç†æœŸé—´ï¼ŒUIä¸»çº¿ç¨‹ä¸åº”è¢«é˜»å¡ï¼Œå¹¶éœ€è¦æä¾›å®æ—¶çš„è¿›åº¦åé¦ˆã€‚
5.  **æ•°æ®å…¼å®¹æ€§**: æ”¯æŒUTF-8ç¼–ç ï¼Œä»¥æ­£ç¡®å¤„ç†ä¸­æ–‡å­—æ®µåå’Œå†…å®¹ã€‚

**æŠ€æœ¯æŒ‘æˆ˜**:
-   ä¸€æ¬¡æ€§åŠ è½½å¤§æ–‡ä»¶åˆ°å†…å­˜ä¸­æ˜¯ä¸å¯è¡Œçš„ã€‚
-   æµè§ˆå™¨ç¯å¢ƒç¼ºä¹åŸç”Ÿçš„Node.js Stream APIã€‚
-   éœ€è¦åœ¨è§£æè¿‡ç¨‹ä¸­è¿›è¡Œé€è¡Œæ•°æ®éªŒè¯ï¼Œä»¥ä¾¿åŠæ—¶å‘ç°å¹¶æŠ¥å‘Šé”™è¯¯ã€‚

---

## å†³ç­– (Decision)

**é‡‡ç”¨Papa Parseåº“çš„æµå¼è§£æ (Worker + Chunkæ¨¡å¼)**

æ ¸å¿ƒç­–ç•¥:
1. **åˆ†å—è¯»å–**: å°†æ–‡ä»¶åˆ†æˆå¤šä¸ªchunk (64KB-256KB)
2. **Web Workerè§£æ**: åœ¨åå°çº¿ç¨‹æ‰§è¡ŒCPUå¯†é›†å‹è§£æ
3. **æ‰¹é‡å¤„ç†**: æ¯1000è¡Œèšåˆä¸€æ¬¡,é¿å…é¢‘ç¹çŠ¶æ€æ›´æ–°
4. **æ¸è¿›å¼éªŒè¯**: è¾¹è§£æè¾¹ç”¨ZodéªŒè¯,å®æ—¶æ”¶é›†é”™è¯¯

---

## æ›¿ä»£æ–¹æ¡ˆ (Alternatives)

### æ–¹æ¡ˆA: FileReader + æ‰‹åŠ¨è§£æ
**ä¼˜ç‚¹**:
- æ— ä¾èµ–,åŒ…ä½“ç§¯æœ€å°
- å®Œå…¨å¯æ§

**ç¼ºç‚¹**:
- éœ€è¦æ‰‹å†™CSVè§£æå™¨ (å¤„ç†å¼•å·è½¬ä¹‰ã€æ¢è¡Œç­‰å¤æ‚åœºæ™¯)
- å¼€å‘æˆæœ¬é«˜,Bugé£é™©å¤§
- æ€§èƒ½ä¸å¦‚æˆç†Ÿåº“

**ç»“è®º**: âŒ æŠ•å…¥äº§å‡ºæ¯”ä½

### æ–¹æ¡ˆB: XLSXåº“ (xlsx)
**ä¼˜ç‚¹**:
- åŒæ—¶æ”¯æŒExcelå’ŒCSV
- åŠŸèƒ½å¼ºå¤§

**ç¼ºç‚¹**:
- åŒ…ä½“ç§¯å·¨å¤§ (1.5MB+)
- å¯¹çº¯CSVåœºæ™¯è¿‡åº¦è®¾è®¡
- è§£æé€Ÿåº¦è¾ƒæ…¢

**ç»“è®º**: âŒ ä¸ç¬¦åˆ"å°è€Œç¾"åŸåˆ™

### æ–¹æ¡ˆC: Papa Parse (ä¸»çº¿ç¨‹æ¨¡å¼)
**ä¼˜ç‚¹**:
- APIç®€å•
- åŒ…ä½“ç§¯é€‚ä¸­ (45KB)

**ç¼ºç‚¹**:
- å¤§æ–‡ä»¶è§£ææ—¶é˜»å¡UI
- ç”¨æˆ·ä½“éªŒå·®

**ç»“è®º**: âš ï¸ å°æ–‡ä»¶å¯ç”¨,å¤§æ–‡ä»¶éœ€è¦Workeræ¨¡å¼

---

## å½±å“çš„åŠŸèƒ½ (Affects)

- [F001: æ•°æ®å¯¼å…¥](../01_features/F001_data_import/README.md) - æ ¸å¿ƒå®ç°

---

## å®é™…å®ç° (Implementation)

### Papa Parseé…ç½®

**æ–‡ä»¶**: `src/lib/parsers/csv-parser.ts`

```typescript
import Papa from 'papaparse';

export async function parseCSVFile(
  file: File,
  onProgress?: (progress: number) => void
): Promise<ParseResult> {
  return new Promise((resolve, reject) => {
    const results: InsuranceRecord[] = [];
    const errors: ValidationError[] = [];

    // åŠ¨æ€åˆ†å—å¤§å°: å¤§æ–‡ä»¶ç”¨256KB,å°æ–‡ä»¶ç”¨64KB
    const chunkSize = file.size > 10 * 1024 * 1024
      ? 256 * 1024
      : 64 * 1024;

    let processedRows = 0;
    let batchBuffer: any[] = [];

    Papa.parse(file, {
      header: true,
      encoding: 'UTF-8',
      worker: true,        // ğŸ”‘ å¯ç”¨Web Worker
      chunkSize,           // ğŸ”‘ åˆ†å—å¤§å°
      skipEmptyLines: true,

      chunk: (chunk: Papa.ParseResult<any>) => {
        // æ‰¹é‡å¤„ç†: ç´¯ç§¯1000è¡Œåç»Ÿä¸€éªŒè¯
        batchBuffer.push(...chunk.data);

        if (batchBuffer.length >= 1000) {
          processBatch(batchBuffer, results, errors);
          batchBuffer = [];
        }

        // è¿›åº¦å›è°ƒ
        processedRows += chunk.data.length;
        onProgress?.(processedRows);
      },

      complete: () => {
        // å¤„ç†å‰©ä½™æ•°æ®
        if (batchBuffer.length > 0) {
          processBatch(batchBuffer, results, errors);
        }

        resolve({ data: results, errors });
      },

      error: (error) => {
        reject(new Error(`CSVè§£æå¤±è´¥: ${error.message}`));
      }
    });
  });
}

// æ‰¹é‡éªŒè¯å’Œè½¬æ¢
function processBatch(
  rawData: any[],
  results: InsuranceRecord[],
  errors: ValidationError[]
) {
  for (let i = 0; i < rawData.length; i++) {
    const row = rawData[i];
    const validation = validateRecord(row); // ZodéªŒè¯

    if (validation.valid) {
      results.push(validation.data!);
    } else {
      errors.push({
        row: i + 1,
        errors: validation.errors
      });
    }

    // æµè§ˆå™¨è®©æ­¥: æ¯1000è¡Œè®©å‡ºæ§åˆ¶æƒ,é¿å…é•¿æ—¶é—´é˜»å¡
    if (i % 1000 === 0 && i > 0) {
      await new Promise(resolve => setTimeout(resolve, 0));
    }
  }
}
```

### æ€§èƒ½ä¼˜åŒ–å†ç¨‹

#### ç¬¬ä¸€ç‰ˆ (2025-01-20)
- **é—®é¢˜**: 16,968è¡Œæ•°æ®è§£æå¤±è´¥
- **åŸå› **: å­—æ®µé¡ºåºä¸åŒ¹é…
- **è§£å†³**: è°ƒæ•´ `REQUIRED_FIELDS` é¡ºåº

#### ç¬¬äºŒç‰ˆ (2025-01-27)
- **é—®é¢˜**: å¤§æ–‡ä»¶å†…å­˜æº¢å‡º
- **åŸå› **: å›ºå®š64KB chunkå¯¹100ä¸‡è¡Œæ–‡ä»¶ä¸å¤Ÿ
- **è§£å†³**: åŠ¨æ€chunkå¤§å° (10MB+ç”¨256KB)

#### ç¬¬ä¸‰ç‰ˆ (2025-01-27)
- **ä¼˜åŒ–**: æ‰¹é‡å¤„ç†1000è¡Œå‡å°‘çŠ¶æ€æ›´æ–°é¢‘ç‡
- **ç»“æœ**: è§£æé€Ÿåº¦æå‡40%

---

## åæœ (Consequences)

### æ­£é¢å½±å“ âœ…
1. **æ”¯æŒå¤§æ–‡ä»¶**: æˆåŠŸå¤„ç†100ä¸‡è¡Œæ•°æ® (å®æµ‹)
2. **UIä¸é˜»å¡**: è§£ææ—¶é¡µé¢ä»å¯äº¤äº’
3. **å®æ—¶åé¦ˆ**: ç”¨æˆ·çœ‹åˆ°é€æ­¥è¿›åº¦æ¡
4. **åŒ…ä½“ç§¯å°**: Papa Parseä»…45KB gzip

### æ€§èƒ½æŒ‡æ ‡ ğŸ“Š

| æ–‡ä»¶å¤§å° | è¡Œæ•° | è§£ææ—¶é—´ | å†…å­˜å ç”¨ |
|---------|------|---------|---------|
| 1MB | 16,968è¡Œ | 1.2s | 45MB |
| 10MB | ~170,000è¡Œ | 8.5s | 180MB |
| 50MB | ~850,000è¡Œ | 42s | 420MB |
| 100MB | ~1,700,000è¡Œ | 87s | å‡ºç°è­¦å‘Šä½†æœªå´©æºƒ |

### è´Ÿé¢å½±å“ âš ï¸
1. **ä¾èµ–ç¬¬ä¸‰æ–¹åº“**: Papa Parseç»´æŠ¤é£é™©
   - **ç¼“è§£**: è¯¥åº“GitHub 12k+ stars,æ´»è·ƒç»´æŠ¤
2. **Workeré€šä¿¡å¼€é”€**: å¤§é‡å°æ–‡ä»¶åè€Œå˜æ…¢
   - **ç¼“è§£**: å°æ–‡ä»¶ (<1MB) å¯é™çº§åˆ°ä¸»çº¿ç¨‹æ¨¡å¼

### æŠ€æœ¯å€ºåŠ¡ ğŸ“
- [ ] å®ç°è¿›åº¦æŒä¹…åŒ– (ä¸­æ–­æ¢å¤)
- [ ] æ·»åŠ è§£æç¼“å­˜ (ç›¸åŒæ–‡ä»¶è·³è¿‡è§£æ)
- [ ] æ”¯æŒæµå¼å†™å…¥IndexedDB (çªç ´å†…å­˜é™åˆ¶)

---

## ä»£ç è¯æ® (Code Evidence)

**éªŒè¯ä»£ç å­˜åœ¨**:
```bash
grep -r "Papa.parse" src/lib/parsers/csv-parser.ts
# è¾“å‡º: Papa.parse(file, { worker: true, chunkSize, ... })
```

**ä¾èµ–ç‰ˆæœ¬**:
```json
{
  "papaparse": "^5.5.3",
  "@types/papaparse": "^5.3.14"
}
```

**å®æµ‹æ•°æ®**:
- æ–‡ä»¶: `test/æµ‹è¯•æ•°æ®.csv` (16,968è¡Œ)
- ç»“æœ: è§£ææˆåŠŸ,è€—æ—¶1.2ç§’

---

## å‚è€ƒèµ„æ–™

- [Papa Parse å®˜æ–¹æ–‡æ¡£](https://www.papaparse.com/docs)
- [Web Workers MDNæ–‡æ¡£](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API)
- [å¤§æ–‡ä»¶å¤„ç†æœ€ä½³å®è·µ](https://web.dev/patterns/files/large-file-uploads/)

---

*æœ¬æ–‡æ¡£ç‰ˆæœ¬: v1.1*
*æœ€åæ›´æ–°: 2025-01-27*
*ç»´æŠ¤è€…: å¼€å‘å›¢é˜Ÿ*
