# æ¶æ„é‡æ„æŒ‡å— - æ¨¡å—åŒ–å‡çº§

## ğŸ“… æ–‡æ¡£ä¿¡æ¯
- **åˆ›å»ºæ—¥æœŸ**: 2025-10-22
- **ç‰ˆæœ¬**: 1.0.0
- **çŠ¶æ€**: ğŸš§ å®æ–½ä¸­ - é˜¶æ®µ1
- **è´Ÿè´£äºº**: AIåŠ©æ‰‹ + å¼€å‘å›¢é˜Ÿ

---

## ğŸ¯ é‡æ„ç›®æ ‡

åŸºäº**"éå¿…è¦ä¸è€¦åˆï¼Œé˜²æ­¢å•ç‚¹å¼•å‘å…¨å±€åå¡Œ"**çš„æ ¸å¿ƒåŸåˆ™ï¼Œå°†å½“å‰çš„å•ä½“Storeæ¶æ„é‡æ„ä¸º**æ¨¡å—åŒ–ã€å¯æµ‹è¯•ã€å¯æ‰©å±•**çš„åˆ†å±‚æ¶æ„ã€‚

### æ ¸å¿ƒé—®é¢˜
1. âŒ **useAppStore** æˆä¸º991è¡Œçš„è¶…çº§ä»“åº“ï¼Œæ‰¿æ‹…è¿‡å¤šèŒè´£
2. âŒ **åŒStoreå¹¶å­˜**ä½†èŒè´£é‡å ï¼ˆpremiumTargets vs goalStoreï¼‰
3. âŒ **é€»è¾‘é‡å¤**ï¼šç­›é€‰é€»è¾‘åœ¨Storeå’ŒHookä¸­é‡å¤å®ç°
4. âŒ **æ·±åº¦è€¦åˆ**ï¼š71%çš„ç»„ä»¶ç›´æ¥ä¾èµ–å…¨å±€Store
5. âŒ **æŒä¹…åŒ–åˆ†æ•£**ï¼š3å¤„ä¸åŒçš„å®ç°

### é‡æ„ç›®æ ‡
- âœ… **é™ä½è€¦åˆ**ï¼šç»„ä»¶é€šè¿‡Hooksè®¿é—®ï¼Œè€Œéç›´æ¥ä¾èµ–Store
- âœ… **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªStore/Serviceåªè´Ÿè´£ä¸€ä¸ªé¢†åŸŸ
- âœ… **æ˜“äºæµ‹è¯•**ï¼šçº¯å‡½æ•°+ä¾èµ–æ³¨å…¥
- âœ… **å¯æ›¿æ¢**ï¼šæ¥å£åŒ–è®¾è®¡ï¼Œæ–¹ä¾¿æœªæ¥å‡çº§

---

## ğŸ—ï¸ æ–°æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ã€å±•ç¤ºå±‚ã€‘                            â”‚
â”‚         Components & Pages                       â”‚
â”‚    (åªè´Ÿè´£æ¸²æŸ“ï¼Œæ— ä¸šåŠ¡é€»è¾‘)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ Props + Custom Hooks
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ã€åº”ç”¨å±‚ã€‘                               â”‚
â”‚        Domain-specific Hooks                     â”‚
â”‚  useInsuranceData | useKPICalculation            â”‚
â”‚  useTargetManagement | useFiltering              â”‚
â”‚    (èšåˆé¢†åŸŸçŠ¶æ€ï¼Œæä¾›ä¸šåŠ¡æ¥å£)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ è°ƒç”¨Store + Service
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ã€çŠ¶æ€å±‚ã€‘Domain Stores                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚DataStore â”‚ â”‚FilterStoreâ”‚ â”‚TargetStoreâ”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚CacheStoreâ”‚ â”‚  UIStore  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚    (ç®¡ç†çŠ¶æ€ï¼Œè°ƒç”¨Serviceå¤„ç†ä¸šåŠ¡)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ è°ƒç”¨çº¯ä¸šåŠ¡é€»è¾‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ã€æœåŠ¡å±‚ã€‘Business Services                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ DataService    - æ•°æ®CRUDã€è¿‡æ»¤èšåˆ  â”‚         â”‚
â”‚  â”‚ KPIService     - KPIè®¡ç®—å¼•æ“        â”‚         â”‚
â”‚  â”‚ PersistenceService - æŒä¹…åŒ–æŠ½è±¡å±‚   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚    (çº¯å‡½æ•°ï¼Œæ— çŠ¶æ€ï¼Œå¯ç‹¬ç«‹æµ‹è¯•)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ è°ƒç”¨é€‚é…å™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       ã€åŸºç¡€è®¾æ–½å±‚ã€‘Adapters & Interfaces          â”‚
â”‚  IPersistenceAdapter  â† LocalStorageAdapter      â”‚
â”‚                       â† IndexedDBAdapter (æœªæ¥)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ å·²å®Œæˆçš„æ¨¡å—

### 1. æœåŠ¡å±‚ï¼ˆServicesï¼‰

#### âœ… IPersistenceAdapter (æ¥å£)
**ä½ç½®**: `src/services/interfaces/IPersistenceAdapter.ts`

**èŒè´£**: å®šä¹‰æŒä¹…åŒ–æ“ä½œçš„æ ‡å‡†æ¥å£

```typescript
interface IPersistenceAdapter {
  save<T>(key: string, data: T): Promise<void>
  load<T>(key: string): Promise<T | null>
  remove(key: string): Promise<void>
  clear(): Promise<void>
  has(key: string): Promise<boolean>
  getStats(): Promise<{ totalKeys, totalSize, availableSpace }>
}
```

**ä¼˜ç‚¹**:
- ğŸ”Œ æ–¹ä¾¿æœªæ¥ä»LocalStorageè¿ç§»åˆ°IndexedDB
- ğŸ§ª æ˜“äºMockè¿›è¡Œå•å…ƒæµ‹è¯•
- ğŸ“¦ ç¬¦åˆä¾èµ–å€’ç½®åŸåˆ™

---

#### âœ… LocalStorageAdapter (å®ç°)
**ä½ç½®**: `src/services/adapters/LocalStorageAdapter.ts`

**èŒè´£**: åŸºäºæµè§ˆå™¨LocalStorageçš„æŒä¹…åŒ–å®ç°

**ç‰¹æ€§**:
- è‡ªåŠ¨JSONåºåˆ—åŒ–/ååºåˆ—åŒ–
- å­˜å‚¨ç©ºé—´æ£€æµ‹å’Œquotaé”™è¯¯å¤„ç†
- æ•°æ®å®Œæ•´æ€§æ ¡éªŒ
- äººç±»å¯è¯»çš„å­˜å‚¨ç»Ÿè®¡

---

#### âœ… PersistenceService (ç»Ÿä¸€æœåŠ¡)
**ä½ç½®**: `src/services/PersistenceService.ts`

**èŒè´£**: åº”ç”¨æ•°æ®æŒä¹…åŒ–çš„ç»Ÿä¸€å…¥å£

**æ›¿ä»£ä»¥ä¸‹3å¤„åˆ†æ•£å®ç°**:
1. `src/lib/storage/data-persistence.ts` (273è¡Œ)
2. `src/store/use-app-store.ts` (637-690è¡Œçš„æŒä¹…åŒ–æ–¹æ³•)
3. `src/hooks/use-persist-data.ts`

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
class PersistenceService {
  // åŸå§‹æ•°æ®
  async saveRawData(data: InsuranceRecord[]): Promise<void>
  async loadRawData(): Promise<InsuranceRecord[] | null>
  async getStorageInfo(): Promise<DataStorageInfo | null>

  // ä¸Šä¼ å†å²
  async addUploadHistory(batchResult, files): Promise<void>
  async getUploadHistory(): Promise<UploadHistoryRecord[]>
  async checkFileExists(file: File): Promise<{exists, uploadRecord, fileInfo}>

  // å…¶ä»–æ•°æ®
  async savePremiumTargets(targets): Promise<void>
  async loadPremiumTargets<T>(): Promise<T | null>
  async saveFilterState(filters): Promise<void>
  async loadFilterState<T>(): Promise<T | null>

  // é€šç”¨æ“ä½œ
  async clearAll(): Promise<void>
  async getStats(): Promise<StorageStats>
}

// å•ä¾‹å¯¼å‡º
export const persistenceService = new PersistenceService()
```

---

#### âœ… DataService (æ•°æ®ç®¡ç†)
**ä½ç½®**: `src/services/DataService.ts`

**èŒè´£**: ä¿é™©æ•°æ®çš„è¿‡æ»¤ã€èšåˆã€ç»Ÿè®¡ç­‰æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

**ç»Ÿä¸€ä»¥ä¸‹æ•£è½é€»è¾‘**:
1. `use-app-store.ts` ä¸­çš„ `useFilteredData` (698-843è¡Œ)
2. `use-app-store.ts` ä¸­çš„ `filterRecordsWithExclusions` (848-973è¡Œ)
3. `use-kpi.ts` ä¸­é‡å¤çš„ç­›é€‰é€»è¾‘ (95-247è¡Œ)

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
class DataService {
  // æ ¸å¿ƒç­›é€‰ï¼ˆæ¶ˆé™¤é‡å¤é€»è¾‘ï¼‰
  static filter(rawData, filters, excludeKeys?): InsuranceRecord[]

  // å‘¨æ¬¡ç›¸å…³
  static getByWeek(rawData, weekNumber, filters?): InsuranceRecord[]
  static getByWeekRange(rawData, [start, end], filters?): InsuranceRecord[]

  // æ•°æ®å¤„ç†
  static deduplicate(data): InsuranceRecord[]
  static merge(...dataSets): InsuranceRecord[]
  static normalize(data): InsuranceRecord[]

  // èšåˆåˆ†æ
  static groupBy<K>(data, dimension: K): Map<K, InsuranceRecord[]>
  static getStatistics(data): { totalRecords, totalPremium, ... }

  // ç­›é€‰è”åŠ¨
  static getAvailableOptions(data, currentFilters, targetField): string[] | number[]
}
```

**ä¼˜ç‚¹**:
- ğŸ” æ¶ˆé™¤é€»è¾‘é‡å¤ï¼šç­›é€‰é€»è¾‘åªåœ¨ä¸€å¤„ç»´æŠ¤
- ğŸ§ª çº¯å‡½æ•°ï¼šæ‰€æœ‰æ–¹æ³•æ— å‰¯ä½œç”¨ï¼Œæ˜“äºæµ‹è¯•
- ğŸ“Š å¯å¤ç”¨ï¼šä»»ä½•åœ°æ–¹éƒ½å¯ä»¥è°ƒç”¨ï¼Œä¸ä¾èµ–Store

---

#### âœ… KPIService (è®¡ç®—æœåŠ¡)
**ä½ç½®**: `src/services/KPIService.ts`

**èŒè´£**: å°è£…æ‰€æœ‰KPIè®¡ç®—é€»è¾‘ï¼Œæä¾›ç»Ÿä¸€è®¡ç®—æ¥å£

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
class KPIService {
  // åŸºç¡€è®¡ç®—
  static calculate(data, options): KPIResult | null
  static calculateIncrement(currentWeekData, previousWeekData, options): KPIResult | null

  // è¶‹åŠ¿åˆ†æ
  static calculateTrend(rawData, filters, options): Map<number, KPIResult>
  static calculateSmartComparison(rawData, currentWeek, filters, annualTarget): {...}

  // ç»´åº¦åˆ†æ
  static calculateByDimension<K>(rawData, dimension: K, filters): Map<K, KPIResult>
  static calculateBatch(rawData, filtersList): KPIResult[]

  // è¾…åŠ©è®¡ç®—
  static calculateAchievementRate(actual, target): number
  static calculateTimeProgress(currentDate, year?): number
  static calculateGrowthRate(currentKpi, comparisonKpi): {...}
}
```

**ä¼˜ç‚¹**:
- ğŸ“¦ å¤ç”¨ç°æœ‰kpi-engineï¼Œä½œä¸ºé€‚é…å±‚
- ğŸ¯ ç»Ÿä¸€æ¥å£ï¼Œæ¶ˆé™¤Hookä¸­çš„é‡å¤è®¡ç®—
- ğŸ§® çº¯å‡½æ•°ï¼Œ100%å¯æµ‹è¯•

---

### 2. çŠ¶æ€å±‚ï¼ˆDomain Storesï¼‰

#### âœ… DataStore (æ•°æ®ç®¡ç†)
**ä½ç½®**: `src/store/domains/dataStore.ts`

**èŒè´£**: ä¸“æ³¨äºä¿é™©æ•°æ®çš„å­˜å‚¨å’ŒåŸºæœ¬æ“ä½œ

**ä»useAppStoreæ‹†åˆ†å‡ºçš„éƒ¨åˆ†**:
- `rawData: InsuranceRecord[]`
- `isLoading, error, uploadProgress`
- `setRawData, appendRawData, clearData`
- æ•°æ®æŒä¹…åŒ–ç›¸å…³æ–¹æ³•

**æ ¸å¿ƒæ¥å£**:
```typescript
interface DataStore {
  // çŠ¶æ€
  rawData: InsuranceRecord[]
  isLoading: boolean
  error: Error | null
  uploadProgress: number

  // æ“ä½œ
  setData(data, autoSave?): Promise<void>
  appendData(data, autoSave?): Promise<void>
  clearData(clearStorage?): Promise<void>
  loadFromStorage(): Promise<void>
  saveToStorage(): Promise<void>

  // é€‰æ‹©å™¨
  getStats(): { totalRecords, totalPremium, ... }
  hasData(): boolean
}
```

**ä¼˜ç‚¹**:
- ğŸ¯ å•ä¸€èŒè´£ï¼šåªç®¡ç†åŸå§‹æ•°æ®
- ğŸ”„ è‡ªåŠ¨è§„èŒƒåŒ–ï¼šä½¿ç”¨DataService.normalize()
- ğŸ’¾ è‡ªåŠ¨æŒä¹…åŒ–ï¼šè°ƒç”¨PersistenceService
- ğŸ“ è¡Œæ•°å‡å°‘ï¼šä»991è¡Œç¼©å‡åˆ°170è¡Œ

---

#### âœ… FilterStore (ç­›é€‰ç®¡ç†)
**ä½ç½®**: `src/store/domains/filterStore.ts`

**èŒè´£**: ä¸“æ³¨äºç­›é€‰æ¡ä»¶çš„ç®¡ç†

**ä»useAppStoreæ‹†åˆ†å‡ºçš„éƒ¨åˆ†**:
- `filters: FilterState`
- `updateFilters, resetFilters`
- `setViewMode`

**æ ¸å¿ƒæ¥å£**:
```typescript
interface FilterStore {
  // çŠ¶æ€
  filters: FilterState

  // æ“ä½œ
  updateFilters(filters: Partial<FilterState>): void
  resetFilters(): void
  setViewMode(mode: 'single' | 'trend'): void
  setDataViewType(type: 'current' | 'increment'): void

  // è®¡ç®—å±æ€§
  getActiveFilterCount(): number
  isFilterActive(key: keyof FilterState): boolean
}
```

**ç‰¹æ€§**:
- ğŸ“¦ æŒä¹…åŒ–ï¼šä½¿ç”¨Zustandçš„persistä¸­é—´ä»¶
- ğŸ”„ è‡ªåŠ¨è§„èŒƒåŒ–ï¼šä¸­æ–‡æ–‡æœ¬è‡ªåŠ¨æ ‡å‡†åŒ–
- ğŸ“Š çŠ¶æ€è®¡ç®—ï¼šæä¾›æ¿€æ´»ç­›é€‰å™¨æ•°é‡ç­‰æ´¾ç”ŸçŠ¶æ€

---

## ğŸ”„ è¿ç§»ç­–ç•¥

### é˜¶æ®µ1ï¼šæ— ä¾µå…¥å¼é‡æ„ï¼ˆå½“å‰ï¼‰âœ…

**ç›®æ ‡**: åˆ›å»ºæ–°æ¶æ„ï¼Œä¿æŒ100%å‘åå…¼å®¹

**å·²å®Œæˆ**:
- âœ… åˆ›å»ºæœåŠ¡å±‚ï¼ˆPersistenceService, DataService, KPIServiceï¼‰
- âœ… åˆ›å»ºé¢†åŸŸStoresï¼ˆDataStore, FilterStoreï¼‰
- âœ… ä¿ç•™åŸæœ‰useAppStoreå’ŒgoalStore

**çŠ¶æ€**: ğŸŸ¢ æ–°æ—§æ¶æ„å¹¶å­˜ï¼Œäº’ä¸å½±å“

---

### é˜¶æ®µ2ï¼šæ¸è¿›å¼è¿ç§»ï¼ˆä¸‹ä¸€æ­¥ï¼‰

**è®¡åˆ’**:
1. **åˆ›å»ºèšåˆHooks**
   ```typescript
   // src/hooks/domains/useInsuranceData.ts
   export function useInsuranceData() {
     const rawData = useDataStore(s => s.rawData)
     const filters = useFilterStore(s => s.filters)

     const filteredData = useMemo(() =>
       DataService.filter(rawData, filters),
       [rawData, filters]
     )

     return { rawData, filteredData, stats: DataService.getStatistics(filteredData) }
   }
   ```

2. **é€é¡µé¢è¿ç§»**
   - ä¼˜å…ˆçº§ï¼š`targets` é¡µé¢ â†’ `KPI` é¡µé¢ â†’ `è¶‹åŠ¿` é¡µé¢
   - æ¯ä¸ªé¡µé¢è¿ç§»åè¿›è¡ŒE2Eæµ‹è¯•
   - ç¡®ä¿åŠŸèƒ½æ— æŸ

3. **ç»„ä»¶ç¤ºä¾‹**ï¼ˆè¿ç§»å‰ vs è¿ç§»åï¼‰
   ```typescript
   // âŒ æ—§ä»£ç ï¼šç›´æ¥ä¾èµ–Store
   function Dashboard() {
     const rawData = useAppStore(s => s.rawData)
     const filters = useAppStore(s => s.filters)
     const updateFilters = useAppStore(s => s.updateFilters)

     const filteredData = useFilteredData() // Hookå†…éƒ¨é‡å¤ç­›é€‰é€»è¾‘
     const kpiData = useKPI()

     return <KPIDashboard data={kpiData} />
   }

   // âœ… æ–°ä»£ç ï¼šé€šè¿‡èšåˆHook
   function Dashboard() {
     const { filteredData, stats } = useInsuranceData()
     const { currentKpi } = useKPICalculation(filteredData)
     const { updateFilters } = useFiltering()

     return <KPIDashboard data={currentKpi} stats={stats} />
   }
   ```

---

### é˜¶æ®µ3ï¼šæ¸…ç†é—ç•™ä»£ç 

**è®¡åˆ’**:
- åˆ é™¤æ—§Storeä¸­å·²è¿ç§»çš„ä»£ç 
- æ›´æ–°æ‰€æœ‰æ–‡æ¡£å’Œå¼€å‘æŒ‡å—
- æ€§èƒ½åŸºå‡†æµ‹è¯•å¯¹æ¯”

---

## ğŸ“ ä½¿ç”¨æ–°æ¶æ„çš„ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæ•°æ®æŒä¹…åŒ–

```typescript
// âŒ æ—§æ–¹å¼ï¼ˆ3å¤„ä¸åŒå®ç°ï¼‰
import { saveDataToStorage } from '@/lib/storage/data-persistence'
await saveDataToStorage(data)

// âœ… æ–°æ–¹å¼ï¼ˆç»Ÿä¸€æ¥å£ï¼‰
import { persistenceService } from '@/services/PersistenceService'
await persistenceService.saveRawData(data)
```

### ç¤ºä¾‹2ï¼šæ•°æ®ç­›é€‰

```typescript
// âŒ æ—§æ–¹å¼ï¼ˆé€»è¾‘é‡å¤ï¼‰
// åœ¨ useAppStore.ts ä¸­
const filteredData = rawData.filter(record => { /* 150è¡Œç­›é€‰é€»è¾‘ */ })

// åœ¨ use-kpi.ts ä¸­
const filteredData = rawData.filter(record => { /* åˆæ˜¯150è¡Œç­›é€‰é€»è¾‘ */ })

// âœ… æ–°æ–¹å¼ï¼ˆå•ä¸€æ¥æºï¼‰
import { DataService } from '@/services/DataService'
const filteredData = DataService.filter(rawData, filters)
```

### ç¤ºä¾‹3ï¼šKPIè®¡ç®—

```typescript
// âŒ æ—§æ–¹å¼
const kpiData = useKPI() // Hookå†…éƒ¨æ··åˆäº†ä¸šåŠ¡é€»è¾‘

// âœ… æ–°æ–¹å¼ï¼ˆé€»è¾‘åˆ†ç¦»ï¼‰
import { KPIService } from '@/services/KPIService'

// åœ¨Hookä¸­
export function useKPICalculation(data: InsuranceRecord[]) {
  return useMemo(() => KPIService.calculate(data, options), [data, options])
}

// åœ¨æµ‹è¯•ä¸­
test('KPIè®¡ç®—æ­£ç¡®æ€§', () => {
  const mockData = [/* ... */]
  const result = KPIService.calculate(mockData, { annualTargetYuan: 100000 })
  expect(result.achievementRate).toBe(0.8)
})
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### æœåŠ¡å±‚æµ‹è¯•ï¼ˆçº¯å‡½æ•°ï¼Œ100%å¯æµ‹ï¼‰

```typescript
// src/services/__tests__/DataService.test.ts
import { DataService } from '../DataService'

describe('DataService.filter', () => {
  test('åº”æ­£ç¡®ç­›é€‰å¹´ä»½', () => {
    const mockData = [
      { policy_start_year: 2024, ... },
      { policy_start_year: 2025, ... }
    ]

    const result = DataService.filter(mockData, { years: [2024] })

    expect(result).toHaveLength(1)
    expect(result[0].policy_start_year).toBe(2024)
  })

  test('åº”æ­£ç¡®å»é‡', () => {
    const duplicateData = [/* ç›¸åŒè®°å½• */]
    const result = DataService.deduplicate(duplicateData)
    expect(result).toHaveLength(1)
  })
})
```

### Storeæµ‹è¯•ï¼ˆçŠ¶æ€ç®¡ç†ï¼‰

```typescript
// src/store/domains/__tests__/dataStore.test.ts
import { useDataStore } from '../dataStore'

describe('DataStore', () => {
  test('appendDataåº”æ­£ç¡®åˆå¹¶å¹¶å»é‡', async () => {
    const store = useDataStore.getState()

    await store.setData([{ id: 1 }])
    await store.appendData([{ id: 1 }, { id: 2 }]) // åŒ…å«é‡å¤

    expect(store.rawData).toHaveLength(2)
  })
})
```

---

## ğŸ“Š é‡æ„æ•ˆæœå¯¹æ¯”

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æ”¹å–„ |
|------|--------|--------|------|
| **å•ä¸ªStoreè¡Œæ•°** | 991è¡Œ | <200è¡Œ/Store | â†“ 80% |
| **Storeæ•°é‡** | 2ä¸ªï¼ˆèŒè´£é‡å ï¼‰ | 5ä¸ªï¼ˆé¢†åŸŸæ˜ç¡®ï¼‰ | +150% å†…èšæ€§ |
| **é€»è¾‘é‡å¤** | 150è¡Œç­›é€‰é€»è¾‘é‡å¤2æ¬¡ | 0è¡Œé‡å¤ | âœ… å®Œå…¨æ¶ˆé™¤ |
| **æŒä¹…åŒ–å®ç°** | 3å¤„åˆ†æ•£ | 1å¤„ç»Ÿä¸€ | â†“ 67% |
| **å¯æµ‹è¯•æ€§** | å›°éš¾ï¼ˆä¾èµ–å…¨å±€çŠ¶æ€ï¼‰ | ä¼˜ç§€ï¼ˆçº¯å‡½æ•°ï¼‰ | â­â­â­â­â­ |
| **å•ç‚¹æ•…éšœé£é™©** | âš¡âš¡âš¡âš¡âš¡ | âš¡âš¡ | â†“ 60% |

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ä¼˜å…ˆçº§1ï¼ˆç«‹å³ï¼‰
- [ ] åˆ›å»ºèšåˆHooksï¼ˆuseInsuranceData, useKPICalculationï¼‰
- [ ] ä¸ºæ–°æœåŠ¡å±‚ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] åœ¨`targets`é¡µé¢è¯•ç‚¹ä½¿ç”¨æ–°æ¶æ„

### ä¼˜å…ˆçº§2ï¼ˆæœ¬å‘¨ï¼‰
- [ ] è¿ç§»KPIé¡µé¢
- [ ] è¿ç§»è¶‹åŠ¿åˆ†æé¡µé¢
- [ ] ç¼–å†™è¿ç§»æ–‡æ¡£

### ä¼˜å…ˆçº§3ï¼ˆä¸‹å‘¨ï¼‰
- [ ] é€æ­¥ç§»é™¤å¯¹æ—§useAppStoreçš„ä¾èµ–
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
- [ ] æ›´æ–°å¼€å‘æŒ‡å—

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®æ¶æ„è®¾è®¡](./data_architecture.md)
- [æ ¸å¿ƒè®¡ç®—é€»è¾‘](./core_calculations.md)
- [æŠ€æœ¯æ ˆè¯´æ˜](./tech_stack.md)

---

## âœ… æœ€ä½³å®è·µ

### Do'sï¼ˆæ¨èï¼‰
1. âœ… **ç»„ä»¶é€šè¿‡Hooksè®¿é—®æ•°æ®**ï¼Œè€Œéç›´æ¥è°ƒç”¨Store
2. âœ… **ä¸šåŠ¡é€»è¾‘æ”¾åœ¨Serviceå±‚**ï¼Œä¿æŒçº¯å‡½æ•°
3. âœ… **Storeåªç®¡ç†çŠ¶æ€**ï¼Œä¸åŒ…å«å¤æ‚ä¸šåŠ¡é€»è¾‘
4. âœ… **æ–°åŠŸèƒ½ä¼˜å…ˆä½¿ç”¨æ–°æ¶æ„**

### Don'tsï¼ˆé¿å…ï¼‰
1. âŒ ä¸è¦åœ¨ç»„ä»¶ä¸­ç›´æ¥è°ƒç”¨`useDataStore`
2. âŒ ä¸è¦åœ¨Storeä¸­ç¼–å†™æ•°æ®è¿‡æ»¤é€»è¾‘ï¼ˆåº”è°ƒç”¨DataServiceï¼‰
3. âŒ ä¸è¦åœ¨Hookä¸­é‡å¤å®ç°Serviceå·²æœ‰çš„é€»è¾‘
4. âŒ ä¸è¦æ··åˆUIçŠ¶æ€å’Œä¸šåŠ¡æ•°æ®

---

**æœ€åæ›´æ–°**: 2025-10-22
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
